# Cert-Manager with cloudflare domain validation

This will create a cert-manager issuer that uses cloudflare for domain validation.  This is useful for getting SSL certificates for your services.

## Prerequisites

- A Kubernetes cluster OBVIOUSLY
- Cloudflare account API key or token
  
## Setup Instructions

- RTFM: 
  - https://itnext.io/cilium-gateway-api-cert-manager-and-lets-encrypt-updates-cc730818cb17
  - https://cert-manager.io/docs/installation/kubectl/
  - https://cert-manager.io/docs/configuration/acme/dns01/cloudflare/
- Install the cert-manager release manifest
  ```sh
  helm repo add jetstack https://charts.jetstack.io
  helm repo update

  kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.15.0/cert-manager.crds.yaml

  helm install cert-manager jetstack/cert-manager --version v1.15.0 \
    --namespace cert-manager --create-namespace \
    --set "extraArgs={--enable-gateway-api}"
  ```
- Check on the cert-manager pods
  ```sh
  kubectl get pods --namespace cert-manager
  ```
- Create an API token in Cloudflare
- https://dash.cloudflare.com/profile/api-tokens
  ```sh
  This API token will affect the below accounts and zones, along with their respective permissions
  
  All zones - Zone:Read, DNS:Edit
  ```
- Save API token in a secret
  ```sh
  kubectl create secret generic cloudflare-api-token-secret --from-literal=api-token='xxxxxx'
  ```

- create issuer resource
```yaml
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: cloudflare-issuer
spec:
  acme:
    email: joemama@gmail.com # This is the email that will be used to register with Let's Encrypt
    privateKeySecretRef:
      name: cloudflare-private-key # This is the secret that will store the private key.  auto-generated by cert-manager
    server: https://acme-v02.api.letsencrypt.org/directory
    solvers:
    - dns01:
        cloudflare:
          apiTokenSecretRef:
            name: cloudflare-api-token-secret
            key: api-token
```

- No need to create use the cloudflare key if you are using a token.  The token is more secure and has less permissions than the key.